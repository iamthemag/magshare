name: Build MagShare

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Qt and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y qtbase5-dev qttools5-dev-tools qtmultimedia5-dev \
          libqt5x11extras5-dev libxcb1-dev libxcb-screensaver0-dev libx11-dev \
          build-essential debhelper devscripts fakeroot
    
    - name: Build application
      run: |
        qmake magshare-desktop.pro
        make -j$(nproc)
    
    - name: Create .deb package
      run: |
        mkdir -p debian/magshare/usr/bin
        mkdir -p debian/magshare/usr/share/applications
        mkdir -p debian/magshare/usr/share/pixmaps
        mkdir -p debian/magshare/DEBIAN
        
        # Copy binary
        cp test/magshare debian/magshare/usr/bin/
        chmod +x debian/magshare/usr/bin/magshare
        
        # Create desktop file
        cat > debian/magshare/usr/share/applications/magshare.desktop << EOF
        [Desktop Entry]
        Version=1.0
        Type=Application
        Name=MagShare
        Comment=Secure LAN Messenger and File Sharing
        Exec=magshare
        Icon=magshare
        Terminal=false
        Categories=Network;InstantMessaging;
        EOF
        
        # Extract icon from resources if available
        if [ -f "src/beebeep.qrc" ]; then
          # Try to extract icon - this is simplified, you might need rcc tool
          cp debian/magshare/usr/share/pixmaps/magshare.png || true
        fi
        
        # Create control file
        cat > debian/magshare/DEBIAN/control << EOF
        Package: magshare
        Version: 1.1.2
        Section: net
        Priority: optional
        Architecture: amd64
        Depends: libqt5core5a, libqt5gui5, libqt5widgets5, libqt5network5, libqt5multimedia5
        Maintainer: MagShare Team <team@magshare.net>
        Description: Secure LAN Messenger and File Sharing
         MagShare is a secure peer-to-peer messenger and file sharing application
         designed for local area networks.
        EOF
        
        # Build .deb package
        dpkg-deb --build debian/magshare
        mv debian/magshare.deb magshare_1.1.2_amd64.deb
    
    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: magshare-linux
        path: |
          magshare_1.1.2_amd64.deb
          test/magshare

  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '5.15.2'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
    
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
    
    - name: Build application
      run: |
        qmake magshare-desktop.pro
        nmake release
      shell: cmd
    
    - name: Create Windows installer
      run: |
        # Install NSIS if needed
        choco install nsis -y
        
        # Add NSIS to PATH
        echo "C:\Program Files (x86)\NSIS" >> $GITHUB_PATH
        
        # Create installer script
        cat > installer.nsi << 'EOF'
        !define APPNAME "MagShare"
        !define COMPANYNAME "MagShareSW"
        !define DESCRIPTION "Secure LAN Messenger and File Sharing"
        !define VERSIONMAJOR 1
        !define VERSIONMINOR 1
        !define VERSIONBUILD 1
        
        RequestExecutionLevel admin
        
        InstallDir "$PROGRAMFILES64\${APPNAME}"
        
        Name "${APPNAME}"
        outFile "MagShare-1.1.2-Setup.exe"
        
        page directory
        page instfiles
        
        section "install"
            setOutPath $INSTDIR
            file "test\magshare.exe"
            writeUninstaller "$INSTDIR\uninstall.exe"
            
            # Start Menu
            createDirectory "$SMPROGRAMS\${APPNAME}"
            createShortCut "$SMPROGRAMS\${APPNAME}\${APPNAME}.lnk" "$INSTDIR\magshare.exe"
            
            # Registry
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "DisplayName" "${APPNAME}"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "UninstallString" "$INSTDIR\uninstall.exe"
        sectionEnd
        
        section "uninstall"
            delete "$INSTDIR\magshare.exe"
            delete "$INSTDIR\uninstall.exe"
            rmDir "$INSTDIR"
            delete "$SMPROGRAMS\${APPNAME}\${APPNAME}.lnk"
            rmDir "$SMPROGRAMS\${APPNAME}"
            DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}"
        sectionEnd
        EOF
        
        # Build installer (use full path as fallback)
        "C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi || makensis installer.nsi
      shell: bash
    
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: magshare-windows
        path: |
          MagShare-1.1.2-Setup.exe
          test/magshare.exe

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '5.15.2'
        host: 'mac'
        target: 'desktop'
    
    - name: Build application
      run: |
        qmake magshare-desktop.pro
        make -j$(sysctl -n hw.ncpu)
    
    - name: Create .app bundle
      run: |
        mkdir -p MagShare.app/Contents/MacOS
        mkdir -p MagShare.app/Contents/Resources
        
        # Copy binary
        cp test/magshare MagShare.app/Contents/MacOS/
        
        # Copy icon if it exists
        if [ -f "src/magshare.icns" ]; then
          cp src/magshare.icns MagShare.app/Contents/Resources/
        elif [ -f "src/beebeep.icns" ]; then
          cp src/beebeep.icns MagShare.app/Contents/Resources/magshare.icns
        fi
        
        # Create Info.plist
        cat > MagShare.app/Contents/Info.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleDevelopmentRegion</key>
            <string>English</string>
            <key>CFBundleExecutable</key>
            <string>magshare</string>
            <key>CFBundleIconFile</key>
            <string>magshare</string>
            <key>CFBundleIdentifier</key>
            <string>net.magshare.MagShare</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>CFBundleName</key>
            <string>MagShare</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>1.1.2</string>
            <key>CFBundleVersion</key>
            <string>1.1.2</string>
            <key>NSHighResolutionCapable</key>
            <true/>
        </dict>
        </plist>
        EOF
    
    - name: Deploy Qt dependencies
      run: |
        macdeployqt MagShare.app
    
    - name: Create .dmg
      run: |
        # Install create-dmg
        brew install create-dmg
        
        # Create DMG (skip volume icon if not available)
        if [ -f "MagShare.app/Contents/Resources/magshare.icns" ]; then
          create-dmg \
            --volname "MagShare" \
            --volicon "MagShare.app/Contents/Resources/magshare.icns" \
            --window-pos 200 120 \
            --window-size 600 300 \
            --icon-size 100 \
            --icon "MagShare.app" 175 120 \
            --hide-extension "MagShare.app" \
            --app-drop-link 425 120 \
            "MagShare-1.1.2.dmg" \
            "MagShare.app"
        else
          create-dmg \
            --volname "MagShare" \
            --window-pos 200 120 \
            --window-size 600 300 \
            --icon-size 100 \
            --icon "MagShare.app" 175 120 \
            --hide-extension "MagShare.app" \
            --app-drop-link 425 120 \
            "MagShare-1.1.2.dmg" \
            "MagShare.app"
        fi
    
    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: magshare-macos
        path: |
          MagShare-1.1.2.dmg
          MagShare.app

  create-release:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          magshare-linux/magshare_1.1.2_amd64.deb
          magshare-windows/MagShare-1.1.2-Setup.exe
          magshare-macos/MagShare-1.1.2.dmg
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}